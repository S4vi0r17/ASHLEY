rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // COLECCIÓN DE USUARIOS
    // ========================================
    match /users/{userId} {
      // Permitir lectura del propio perfil
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Permitir escritura del propio perfil
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // Lectura pública para marketplace (nombres y fotos de perfil)
      allow read: if request.auth != null;
      
      // ========================================
      // SUBCOLLECTION: FAVORITOS DEL USUARIO
      // ========================================
      match /favorites/{favoriteId} {
        // Solo el usuario puede leer sus propios favoritos
        allow read: if request.auth != null && request.auth.uid == userId;
        
        // Solo el usuario puede agregar/quitar sus favoritos
        allow create, delete: if request.auth != null && request.auth.uid == userId;
        
        // Validar estructura al crear favorito
        allow create: if request.auth != null && 
                        request.auth.uid == userId &&
                        request.resource.data.keys().hasAll(['productId', 'addedAt']) &&
                        request.resource.data.addedAt is timestamp;
      }
    }
    
    // ========================================
    // COLECCIÓN DE PRODUCTOS
    // ========================================
    match /products/{productId} {
      
      // LECTURA: Todos los usuarios autenticados pueden ver productos
      allow read: if request.auth != null;
      
      // CREACIÓN: Usuario autenticado puede crear productos
      // VALIDACIÓN: Campos obligatorios y contadores en 0
      allow create: if request.auth != null && 
                      request.auth.uid == request.resource.data.userId &&
                      request.resource.data.keys().hasAll(['userId', 'title', 'price', 'category']) &&
                      request.resource.data.views == 0 &&
                      request.resource.data.favorites == 0 &&
                      request.resource.data.messagesReceived == 0;
      
      // ACTUALIZACIÓN: Solo el dueño puede modificar su producto
      // EXCEPTO los contadores (views, favorites, messagesReceived)
      allow update: if request.auth != null && 
                      request.auth.uid == resource.data.userId &&
                      // El userId no puede cambiar
                      request.resource.data.userId == resource.data.userId;
      
      // ELIMINACIÓN: Solo el dueño puede eliminar su producto
      allow delete: if request.auth != null && 
                      request.auth.uid == resource.data.userId;
      
      // ========================================
      // REGLA ESPECIAL: CONTADOR DE VISTAS
      // ========================================
      // Cualquier usuario autenticado puede incrementar vistas
      allow update: if request.auth != null &&
                      // Solo se modifica el campo 'views'
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views']) &&
                      // El contador solo puede incrementar en 1
                      request.resource.data.views == resource.data.views + 1;
      
      // ========================================
      // REGLA ESPECIAL: CONTADOR DE FAVORITOS
      // ========================================
      // Cualquier usuario autenticado puede modificar favoritos
      allow update: if request.auth != null &&
                      // Solo se modifica el campo 'favorites'
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['favorites']) &&
                      // El contador puede incrementar o decrementar en 1
                      (request.resource.data.favorites == resource.data.favorites + 1 ||
                       request.resource.data.favorites == resource.data.favorites - 1) &&
                      // No puede ser negativo
                      request.resource.data.favorites >= 0;
      
      // ========================================
      // REGLA ESPECIAL: CONTADOR DE MENSAJES
      // ========================================
      allow update: if request.auth != null &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['messagesReceived']) &&
                      request.resource.data.messagesReceived == resource.data.messagesReceived + 1;
      
      // ========================================
      // SUBCOLLECTION: ESTADÍSTICAS DIARIAS
      // ========================================
      match /product_stats/{date} {
        // El dueño del producto puede leer sus estadísticas
        allow read: if request.auth != null && 
                      request.auth.uid == get(/databases/$(database)/documents/products/$(productId)).data.userId;
        
        // Cualquier usuario autenticado puede crear/actualizar estadísticas
        // (cuando visitan o marcan como favorito)
        allow create: if request.auth != null &&
                        request.resource.data.keys().hasAll(['date', 'views', 'favorites', 'messagesReceived']) &&
                        request.resource.data.views >= 0 &&
                        request.resource.data.favorites >= 0 &&
                        request.resource.data.messagesReceived >= 0;
        
        allow update: if request.auth != null &&
                        // Los contadores solo pueden incrementar
                        request.resource.data.views >= resource.data.views &&
                        request.resource.data.favorites >= resource.data.favorites &&
                        request.resource.data.messagesReceived >= resource.data.messagesReceived;
      }
      
      // ========================================
      // SUBCOLLECTION: CONTROL DE VISTAS POR USUARIO
      // ========================================
      match /user_views/{userId} {
        // El dueño del producto puede ver quién ha visto su producto
        allow read: if request.auth != null && 
                      request.auth.uid == get(/databases/$(database)/documents/products/$(productId)).data.userId;
        
        // Cualquier usuario puede registrar su vista
        allow create, update: if request.auth != null &&
                                request.auth.uid == userId &&
                                request.resource.data.keys().hasAll(['lastViewed', 'viewCount']) &&
                                request.resource.data.lastViewed is timestamp &&
                                request.resource.data.viewCount is int;
      }
    }
    
    // ========================================
    // COLECCIÓN DE MENSAJES/CHAT (Para futuro)
    // ========================================
    match /chats/{chatId} {
      // Los participantes del chat pueden leer
      allow read: if request.auth != null && 
                    (request.auth.uid in resource.data.participants);
      
      // Los participantes pueden escribir
      allow create: if request.auth != null &&
                      request.auth.uid in request.resource.data.participants;
      
      allow update: if request.auth != null &&
                      request.auth.uid in resource.data.participants;
      
      // Subcollection de mensajes
      match /messages/{messageId} {
        allow read: if request.auth != null &&
                      request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        allow create: if request.auth != null &&
                        request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants &&
                        request.auth.uid == request.resource.data.senderId;
      }
    }
    
    // ========================================
    // REGLA POR DEFECTO: DENEGAR TODO LO DEMÁS
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
